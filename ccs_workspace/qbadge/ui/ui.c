/*
 * ui.c
 *
 *  Created on: Jun 3, 2019
 *      Author: george
 */
#include <qbadge.h>
#include <queercon_drivers/epd.h>
#include <queercon_drivers/ht16d35b.h>
#include <stdint.h>
#include <stdio.h>

#include <xdc/runtime/Error.h>

#include <ti/grlib/grlib.h>
#include <ti/sysbios/BIOS.h>
#include <ti/sysbios/knl/Clock.h>
#include <ti/sysbios/knl/Task.h>
#include <ti/sysbios/knl/Event.h>
#include <ti/drivers/PIN.h>

#include "leds.h"
#include "ui.h"
#include "board.h"

static Event_Handle ui_event_h;
Graphics_Context ui_gr_context_landscape;
Graphics_Context ui_gr_context_portrait;

Clock_Handle kb_debounce_clock_h;
PIN_Handle kb_pin_h;
PIN_State btn_state;
PIN_Config btn_row_scan[] = {
    QC16_PIN_KP_ROW_1 | PIN_INPUT_EN | PIN_PULLDOWN,
    QC16_PIN_KP_ROW_2 | PIN_INPUT_EN | PIN_PULLDOWN,
    QC16_PIN_KP_ROW_3 | PIN_INPUT_EN | PIN_PULLDOWN,
    QC16_PIN_KP_ROW_4 | PIN_INPUT_EN | PIN_PULLDOWN,
    QC16_PIN_KP_COL_1 | PIN_GPIO_OUTPUT_EN | PIN_GPIO_HIGH,
    QC16_PIN_KP_COL_2 | PIN_GPIO_OUTPUT_EN | PIN_GPIO_HIGH,
    QC16_PIN_KP_COL_3 | PIN_GPIO_OUTPUT_EN | PIN_GPIO_HIGH,
    QC16_PIN_KP_COL_4 | PIN_GPIO_OUTPUT_EN | PIN_GPIO_HIGH,
    QC16_PIN_KP_COL_5 | PIN_GPIO_OUTPUT_EN | PIN_GPIO_HIGH,
    PIN_TERMINATE
};

uint8_t kb_active_key = BTN_NONE;

#define UI_STACKSIZE 2048
Task_Struct ui_task;
uint8_t ui_task_stack[UI_STACKSIZE];

void kb_clock_swi(UArg a0) {
    static uint8_t button_press = BTN_NONE;
    static uint8_t button_press_prev = BTN_NONE;
    static uint8_t kb_mashed;

    button_press_prev = button_press;
    button_press = BTN_NONE;
    kb_mashed = 0;

    // Set all columns high.
    PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_1, 1);
    PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_2, 1);
    PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_3, 1);
    PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_4, 1);
    PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_5, 1);

    // Check to see if that pulled any rows high.
    for (uint8_t r=1; r<5; r++) {
        // this is row r
        // row pin to read is r+QC16_PIN_KP_ROW_1-1
        PIN_Id pin_to_read;
        if (r < 4) {
            pin_to_read = QC16_PIN_KP_ROW_1 + r - 1;
        } else {
            // TODO: This will change for the black prototype & prod.
            pin_to_read = QC16_PIN_KP_ROW_4;
        }

        if (PIN_getInputValue(pin_to_read)) {
            // high => pressed
            if (button_press & BTN_ROW_MASK) {
                // another row already pressed, kb is mashed.
                // give up. a mashed keyboard helps nobody.
                kb_mashed = 1;
                break;
            }
            button_press = r << 3; // row is the upper nibble.

            // Now, figure out which column it is. Set all columns low:
            PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_1, 0);
            PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_2, 0);
            PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_3, 0);
            PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_4, 0);
            PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_5, 0);

            // set each column high, in turn:
            for (uint8_t c=1; c<6; c++) {
                PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_1 + c - 1, 1);
                if (PIN_getInputValue(pin_to_read)) {
                    // If the relevant row reads high, this col,row is pressed.
                    if (button_press & BTN_COL_MASK) {
                        // if multiple columns are pressed already, then
                        // we have a mashing situation on our hands.
                        kb_mashed = 1;
                    }
                    button_press |= c; // row is already in the upper nibble.
                }
                PIN_setOutputValue(kb_pin_h, QC16_PIN_KP_COL_1 + c - 1, 0);
            }
        }
    }

    // If the row bits and col bits aren't BOTH populated with a value,
    //  then we got a malformed press (row without col, or col without row),
    //  and we should force it to be BTN_NONE.
    if (!((button_press & BTN_ROW_MASK) && (button_press & BTN_COL_MASK))) {
        button_press = BTN_NONE;
    }

    // If there is currently an active key signaled, and EITHER
    //  the keypad is mashed OR a key-release has been debounced,
    //  then that's a release!
    if ((kb_active_key & BTN_PRESSED)
            && (kb_mashed || (!button_press && !button_press_prev))) {
        kb_active_key &= ~BTN_PRESSED;
        Event_post(ui_event_h, UI_EVENT_KB_RELEASE);
    } else if (!(kb_active_key & BTN_PRESSED) && button_press && button_press == button_press_prev) {
        // A button is pressed.
        kb_active_key = button_press | BTN_PRESSED;
        Event_post(ui_event_h, UI_EVENT_KB_PRESS);
    }
}

void ui_draw_top_bar() {
    // Draw the top bar.
    Graphics_drawLine(&ui_gr_context_landscape, 0, 28, 295, 28);

    // Draw the battery symbol.
    // Determine the battery voltage.
    // 0.5 V is the minimum. 3.0V is the "maximum"
    // They're probably just about empty when we get to 1.8 V.
    Graphics_Rectangle rect;
    rect.xMin = 248;
    rect.xMax = 291;
    rect.yMin = 2;
    rect.yMax = 18;
    Graphics_drawRectangle(&ui_gr_context_landscape, &rect);
    rect.xMin = 291;
    rect.xMax = 295;
    rect.yMin = 6;
    rect.yMax = 13;
    Graphics_drawRectangle(&ui_gr_context_landscape, &rect);

    Graphics_setFont(&ui_gr_context_landscape, &g_sFontCmss16b);
    Graphics_setFont(&ui_gr_context_landscape, &g_sFontFixed6x8);
    char bat_text[5] = "3.0V";
    sprintf(bat_text, "%d.%dV", vbat_out_uvolts/1000000, (vbat_out_uvolts/100000) % 10);
    Graphics_drawStringCentered(&ui_gr_context_landscape, (int8_t *) bat_text, 4, 248 + (291-248)/2, 2 + (18-2)/2, 0);

    Graphics_drawString(&ui_gr_context_landscape, "QBADGE", 6, 0, 0, 0);

    Graphics_flushBuffer(&ui_gr_context_landscape);

    // Is our agent around? Draw the agent symbol.

    // Are there any handlers around? Draw the handler symbol.


}

void ui_draw_main_menu() {
    // Clear the buffer.
    Graphics_clearDisplay(&ui_gr_context_landscape);

    ui_draw_top_bar();

    // Draw the menu itself

}

//////////////////

static const unsigned char pixel_example_photo1BPP_UNCOMP[] =
{
0x7f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xc3, 0xc7, 0xfc,
0x7f, 0xff, 0xff, 0xf1, 0xff, 0xff, 0xfc, 0x1f, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xe7, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xe0, 0xff, 0xff, 0xfe, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xfe, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xfe, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x7c,
0x7f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xfe, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xfe, 0x00, 0x3c,
0x7f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xfe, 0x3f, 0xde, 0x00, 0xff, 0xff, 0x80, 0xfe, 0x3e, 0x1c,
0x7f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xfe, 0x3f, 0x90, 0x00, 0x00, 0x00, 0x04, 0xfc, 0x7f, 0x0c,
0x7f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0x3c, 0x00, 0xfc, 0x00, 0x00, 0x3c, 0xf8, 0xff, 0x84,
0x7f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0x3e, 0x00, 0xff, 0xe7, 0xff, 0xfc, 0xf1, 0xff, 0x84,
0x7f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0x1f, 0x03, 0xff, 0xc7, 0xff, 0xfc, 0xf1, 0xff, 0xcc,
0x7f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0x1f, 0x1f, 0xff, 0xc7, 0xff, 0xfc, 0xf1, 0xff, 0x8c,
0x7f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0x3f, 0x1f, 0xff, 0xc7, 0xff, 0xfc, 0xf1, 0xff, 0x8c,
0x7f, 0xff, 0xff, 0xfc, 0x7f, 0xff, 0xff, 0x1f, 0x1f, 0xff, 0xc7, 0xff, 0xfc, 0xf1, 0xff, 0x8c,
0x7f, 0xff, 0xff, 0xfc, 0x7f, 0xff, 0xff, 0x1f, 0x1f, 0xff, 0xc7, 0xff, 0xfc, 0xf1, 0xff, 0x9c,
0xff, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0x9f, 0x1f, 0xff, 0xe7, 0xff, 0xfc, 0xf1, 0xff, 0x3c,
0x7f, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0x9f, 0x1f, 0xff, 0xe7, 0xff, 0xfc, 0xf8, 0xf0, 0x7c,
0x7f, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0x9f, 0x1f, 0xff, 0xe7, 0xff, 0xfc, 0xfc, 0x60, 0xfc,
0x7f, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0x9f, 0x1f, 0xff, 0xe7, 0xff, 0xfc, 0xff, 0x00, 0xfc,
0x3f, 0xff, 0xf9, 0xfe, 0x7f, 0xcf, 0xff, 0x9e, 0x1f, 0xff, 0xe1, 0xff, 0xfc, 0xc7, 0x83, 0xfc,
0x3f, 0xfe, 0xf1, 0xfe, 0x7f, 0xc7, 0xff, 0x8e, 0x1f, 0xff, 0xe0, 0xff, 0xfc, 0xc7, 0xc3, 0xfc,
0x3f, 0xfe, 0xf9, 0xff, 0x3f, 0xc7, 0xff, 0x8e, 0x1f, 0xff, 0xe1, 0xff, 0xfc, 0xc7, 0xe3, 0xfc,
0x7f, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0x8e, 0x1f, 0xff, 0xe7, 0xff, 0xfc, 0xff, 0xe3, 0xfc,
0x7f, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0x8e, 0x1f, 0xff, 0xe7, 0xff, 0xfc, 0xff, 0xe3, 0xfc,
0x7f, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0x8f, 0x9f, 0xff, 0xe7, 0xff, 0xfc, 0xff, 0xe3, 0xfc,
0x7f, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0x00, 0x07, 0xc1, 0xe7, 0xfd, 0xc0, 0x00, 0x00, 0x3c,
0x7f, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x7f, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0x8c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x7f, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0x8f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe1, 0x00,
0x7f, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0x8f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xfe, 0x1f, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe,
0x7f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe,
0x7f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe,
0x7f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x3f, 0xff, 0xf1, 0xff, 0xcf, 0xc7, 0xff, 0xc2, 0x3f, 0xff, 0xf9, 0xff, 0xff, 0xc7, 0xff, 0xfc,
0x3f, 0xff, 0xf1, 0xff, 0xcf, 0xc7, 0xff, 0xc2, 0x3f, 0xff, 0xf8, 0xff, 0xff, 0xc7, 0xff, 0xfc,
0x7f, 0xff, 0xf9, 0xff, 0xcf, 0xcf, 0xff, 0xe3, 0x3f, 0xff, 0xf9, 0xff, 0xff, 0xe7, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xe0, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xff, 0xe0, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x3f, 0xfc, 0x00,
0x7f, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x07, 0xfc, 0x00,
0x7f, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
0x7f, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
0x7f, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xfd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
0x7f, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xfd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
0x61, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
0x60, 0x3f, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x00, 0x00, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
0x00, 0x00, 0x1f, 0xff, 0x3f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7e, 0x00, 0x01, 0xff, 0x3f, 0xff, 0xff, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xfe, 0x00, 0x0f, 0x3f, 0xff, 0xff, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x7f, 0xff, 0xfc, 0x07, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
0x3f, 0xff, 0xf9, 0xe6, 0x1f, 0xc7, 0xf9, 0xfe, 0x3f, 0xff, 0xf9, 0xff, 0xff, 0xe7, 0xff, 0xfc,
0x3f, 0xff, 0xf1, 0xfe, 0x1f, 0xc7, 0xf1, 0xfe, 0x3f, 0xff, 0xf8, 0xff, 0xff, 0xc7, 0xff, 0xfe,
0x3f, 0xff, 0xf1, 0xfc, 0x1f, 0xc7, 0xe1, 0xfe, 0x3f, 0xff, 0xf8, 0xff, 0xff, 0xc7, 0xff, 0xfe,
0x7f, 0xff, 0xff, 0xf9, 0x1f, 0xff, 0xc1, 0xfc, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe,
0x7f, 0xff, 0xff, 0xc3, 0x1f, 0xfe, 0x09, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe,
0x7f, 0xff, 0xff, 0xc7, 0x1f, 0xfe, 0x39, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe,
0x3f, 0xff, 0xff, 0x8f, 0x1f, 0xfe, 0x78, 0xfd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0x3f, 0xff, 0xff, 0x1f, 0x1f, 0xfe, 0x3c, 0xfd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe,
0x3f, 0xff, 0xfe, 0x3f, 0x1f, 0xfc, 0x7c, 0xfd, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xff, 0xff, 0xff,
0x3f, 0xff, 0xfc, 0x7f, 0x1f, 0xfc, 0x7c, 0xf9, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 0xff,
0x3f, 0xff, 0xf0, 0xff, 0x1f, 0xfc, 0x7e, 0x73, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xff,
0x3f, 0xff, 0xf1, 0xff, 0x1f, 0xfc, 0x7e, 0x73, 0xff, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0xff,
0x3f, 0xff, 0xc3, 0xff, 0x9f, 0xfe, 0x7e, 0x67, 0xff, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xff,
0x3f, 0xff, 0x87, 0xff, 0x9f, 0xfe, 0x7e, 0x67, 0xff, 0xff, 0xff, 0xfc, 0x7f, 0xff, 0xff, 0xff,
0x3f, 0xff, 0x0f, 0xff, 0x9f, 0xfe, 0x7f, 0x6f, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff,
0x3f, 0xfe, 0x1f, 0xff, 0x9f, 0xfe, 0x7f, 0x4f, 0xff, 0xff, 0xff, 0xf8, 0xff, 0xff, 0xff, 0xff,
0x3f, 0xfc, 0x3f, 0xff, 0x9f, 0xfe, 0x7f, 0xdf, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xfe,
0x3f, 0xf8, 0x7f, 0xff, 0x9f, 0xfe, 0x7f, 0x1f, 0xff, 0xff, 0xff, 0xf1, 0xff, 0xff, 0xff, 0xfe,
0x3f, 0xf0, 0xff, 0xff, 0x9f, 0xfe, 0x3e, 0x1f, 0xff, 0xff, 0xff, 0xe3, 0xff, 0xff, 0xff, 0xfe,
0x1f, 0xf1, 0xff, 0xff, 0x9f, 0xff, 0x3f, 0x3f, 0xff, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xfc,
0x1f, 0xc3, 0xff, 0xff, 0x9f, 0xff, 0x3f, 0x3f, 0xff, 0xff, 0xff, 0xf7, 0xff, 0xff, 0xff, 0xf8,
0x1f, 0x87, 0xff, 0xff, 0x9f, 0xef, 0x3f, 0x3f, 0x7f, 0xff, 0xf9, 0xff, 0xff, 0xef, 0xff, 0xf8,
0x1f, 0x0f, 0xf9, 0xff, 0x9f, 0xc7, 0x1e, 0x7e, 0x3f, 0xff, 0xf8, 0xff, 0xff, 0xc7, 0xff, 0xf0,
0x1e, 0x1f, 0xf9, 0xff, 0x9f, 0xc7, 0x1e, 0x7e, 0x3f, 0xff, 0xf8, 0xff, 0xff, 0xc7, 0xff, 0xf2,
0x18, 0x3f, 0xfb, 0xff, 0x9f, 0xff, 0x9c, 0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe3,
0x10, 0x7f, 0xff, 0xff, 0x9f, 0xff, 0x99, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7,
0x00, 0xff, 0xff, 0xff, 0x9f, 0xff, 0x99, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe6,
0x01, 0xff, 0xff, 0xff, 0x9f, 0xff, 0x9b, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xcc,
0x03, 0xff, 0xff, 0xff, 0x8f, 0xff, 0x93, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x89,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x8f,
0x1f, 0xff, 0xff, 0xff, 0x9f, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xef, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1b,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x39,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x7d,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x66,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xbf, 0xff, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xf8, 0x47,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0x3f, 0xff, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xf8, 0xc7,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0x7f, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xff, 0xff, 0xf0, 0xcf,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 0xff, 0xf1, 0x4f,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xff, 0xf3, 0x8f,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xfe, 0xff, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0xff, 0xe3, 0x9f,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xfc, 0xff, 0xff, 0xff, 0xfc, 0x7f, 0xff, 0xff, 0xff, 0xe3, 0x9f,
0x1f, 0xff, 0xff, 0xff, 0x8f, 0xf9, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xe7, 0x1f,
0x1f, 0xff, 0xf9, 0xff, 0xcf, 0xc3, 0xff, 0xfe, 0x3f, 0xf8, 0xf8, 0xff, 0xff, 0xc7, 0xc6, 0x6f,
0x0f, 0xff, 0xf9, 0xff, 0x8f, 0xc3, 0xff, 0xfe, 0x3f, 0xff, 0xf8, 0xff, 0xff, 0xc7, 0x8e, 0x66,
0x1f, 0xff, 0xf9, 0xff, 0xcf, 0xe7, 0xff, 0xff, 0x7f, 0xff, 0xfd, 0xff, 0xff, 0xe7, 0x9e, 0xf3,
0x1f, 0xff, 0xff, 0xff, 0xcf, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1d, 0xf8,
0x1f, 0xff, 0xff, 0xff, 0xc7, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x29, 0xfc,
0x1f, 0xff, 0xff, 0xff, 0xc7, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x3f, 0xfe,
0x1f, 0xff, 0xff, 0xff, 0xc7, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x7f, 0xfe,
0x1f, 0xff, 0xff, 0xff, 0xc7, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x7b, 0xfe,
0x1f, 0xff, 0xff, 0xff, 0xe7, 0xbf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x7b, 0xfe,
0x1f, 0xff, 0xff, 0xff, 0xcf, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xfd, 0xfe,
0x1f, 0xff, 0xff, 0xff, 0xc7, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf1, 0xff, 0xfe,
0x1f, 0xff, 0xff, 0xff, 0xc7, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xfe,
0x1f, 0xff, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe3, 0xff, 0xfe,
0x8f, 0xff, 0xf8, 0xff, 0xc6, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe3, 0xff, 0x7e,
0x8f, 0xff, 0xf9, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xff, 0xfe,
0x8f, 0xff, 0xf1, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xff, 0xfe,
0x8f, 0xff, 0xe0, 0xff, 0xcd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xff,
0x8f, 0xff, 0xcc, 0xff, 0xcd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xff, 0xef,
0x8f, 0xff, 0x9c, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff,
0x8f, 0xff, 0x1c, 0x7f, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff,
0x8f, 0xfe, 0x7c, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x3f, 0xdf, 0xff,
0x0f, 0xfc, 0xf8, 0x7f, 0xff, 0xc7, 0xff, 0xff, 0x3f, 0xff, 0xf9, 0xff, 0xfe, 0x07, 0xff, 0xff,
0x0f, 0xf0, 0xf8, 0x7f, 0xff, 0xc7, 0xff, 0xfe, 0x3f, 0xff, 0xf8, 0xff, 0xfc, 0x47, 0xff, 0xff,
0x0f, 0xf1, 0xf8, 0x7f, 0xff, 0xc7, 0xff, 0xff, 0x1f, 0xff, 0xf9, 0xff, 0xfc, 0xe7, 0xff, 0xfe,
0x0f, 0xf3, 0xfe, 0x3f, 0xef, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 0xff, 0xf8, 0xe7, 0xff, 0xfe,
0x0f, 0xf3, 0xff, 0x3f, 0xcf, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0xff, 0xf1, 0xe7, 0xff, 0xfe,
0x0f, 0xf3, 0xff, 0x3f, 0xdf, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0xf1, 0xc7, 0xff, 0xfe,
0x0f, 0xf1, 0xff, 0x3f, 0x9f, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0xe3, 0xcf, 0xff, 0xfe,
0x0f, 0xf9, 0xff, 0x3f, 0xbf, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xc2, 0x9f, 0xff, 0xfe,
0x0f, 0xfb, 0xff, 0xbf, 0x7f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xc6, 0x1f, 0xff, 0xff,
0x0f, 0xfb, 0xff, 0xbf, 0x7f, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0x87, 0x3f, 0xff, 0xff,
0x0f, 0xf9, 0xff, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0e, 0x3f, 0xff, 0xff,
0x1f, 0xf9, 0xff, 0xdc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0e, 0x1f, 0xff, 0xff,
0x1f, 0xf9, 0xff, 0xdd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1c, 0x9f, 0xff, 0xff,
0x0f, 0xf9, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x3f, 0xcf, 0xff, 0xff,
0x1f, 0xf9, 0xff, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xef, 0xff, 0xff,
0x1f, 0xfd, 0xff, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x3f, 0xe7, 0xff, 0xff,
0x1f, 0xfc, 0xff, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x6f, 0xf7, 0xff, 0xff,
0x1f, 0xfc, 0xff, 0xef, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xe7, 0xf3, 0xff, 0xff,
0x1f, 0xfc, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xe7, 0xfb, 0xff, 0xff,
0x1f, 0xfe, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xf7, 0xfd, 0xff, 0xfe,
0x1f, 0xfe, 0x7f, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf1, 0xf3, 0xfd, 0xff, 0xff,
0x1f, 0xfe, 0x79, 0x3f, 0xff, 0xef, 0xff, 0xff, 0x7f, 0xff, 0xfd, 0xf3, 0xf3, 0xef, 0xff, 0xff,
0x0f, 0xfe, 0x78, 0x7f, 0xff, 0xc7, 0xff, 0xfe, 0x3f, 0xff, 0xf8, 0xe3, 0xf9, 0xc7, 0xff, 0xff,
0x0f, 0xfe, 0x78, 0xff, 0xff, 0xc7, 0xff, 0xfe, 0x3f, 0xff, 0xf8, 0x67, 0xfd, 0xc7, 0xff, 0xfe,
0x0f, 0xfe, 0x7c, 0xff, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xff, 0xff, 0x27, 0xfc, 0xff, 0x3f, 0xfe,
0x0f, 0xff, 0x3d, 0xff, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xff, 0xff, 0x07, 0xfe, 0xff, 0xff, 0xfe,
0x8f, 0xff, 0x39, 0xff, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0x8f, 0xfe, 0x7f, 0xff, 0xfe,
0x8f, 0xff, 0x33, 0xff, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0x0f, 0xff, 0x7f, 0xff, 0xfe,
0x8f, 0xff, 0x33, 0xff, 0xff, 0xff, 0xef, 0xff, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0x3f, 0xff, 0xfe,
0x8f, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xbf, 0xff, 0xfe,
0x8f, 0xff, 0xef, 0xff, 0xff, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xfe, 0x27, 0xff, 0x9f, 0xff, 0xfe,
0x8f, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xff, 0xfc, 0x13, 0xff, 0xdf, 0xff, 0xfe,
0x8f, 0xff, 0x9f, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xff, 0xf8, 0x3b, 0xff, 0xcf, 0xff, 0xfe,
0x8f, 0xff, 0x9f, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0xf8, 0x39, 0xff, 0xe7, 0xff, 0xff,
0x8f, 0xff, 0x3f, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0xf2, 0x7c, 0xff, 0xe7, 0xff, 0xff,
0x8f, 0xff, 0x3f, 0xff, 0xff, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xf6, 0x7e, 0x7f, 0xf7, 0xff, 0xff,
0x8f, 0xfe, 0x7f, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xec, 0xfe, 0x7f, 0xf3, 0xff, 0xff,
0x8f, 0xfc, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xf8, 0xff, 0x3f, 0xfb, 0xff, 0xff,
0x8f, 0xfd, 0xff, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xff, 0x9f, 0xfd, 0xff, 0xff,
0x87, 0xf9, 0xff, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xf3, 0xff, 0xdf, 0xfc, 0xff, 0xff,
0x87, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe3, 0xff, 0xef, 0xfe, 0xff, 0xff,
0xc7, 0xe3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7, 0xff, 0xe7, 0xfe, 0x7f, 0xff,
0xcf, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0xff, 0x7f, 0xff,
0x00, 0x00, 0x00, 0x00, 0x01, 0xc7, 0xfe, 0x7e, 0x00, 0x00, 0x00, 0x3f, 0xf9, 0xc0, 0x3f, 0x80
};

static const unsigned long palette_example_photo1BPP_UNCOMP[]=
{
    0x000000,   0xffffff
};

const tImage  example_photo1BPP_UNCOMP=
{
    IMAGE_FMT_1BPP_UNCOMP,
    128,
    170,
    2,
    palette_example_photo1BPP_UNCOMP,
    pixel_example_photo1BPP_UNCOMP,
};

static const unsigned char pixel_picker1BPP_UNCOMP[] =
{
0xff, 0xff, 0xff, 0xff,
0xff, 0xf0, 0x0f, 0xff,
0xff, 0xf0, 0x0f, 0xff,
0xff, 0xf0, 0x0f, 0xff,
0xff, 0xf0, 0x1f, 0xff,
0xff, 0xf8, 0x1f, 0xff,
0xff, 0xf8, 0x1f, 0xff,
0xff, 0x38, 0x18, 0xff,
0xfe, 0x1c, 0x38, 0x7f,
0xfc, 0x1c, 0x38, 0x3f,
0xfc, 0x0c, 0x30, 0x1f,
0xf8, 0x0e, 0x70, 0x0f,
0xf8, 0x0e, 0x78, 0x0f,
0xf0, 0x1a, 0x48, 0x0f,
0xf0, 0x33, 0xc4, 0x7f,
0xff, 0xe1, 0x87, 0xe7,
0xff, 0xe1, 0x83, 0x87,
0xe0, 0x60, 0x02, 0x07,
0xe0, 0x20, 0x02, 0x07,
0xe0, 0x20, 0x02, 0x07,
0xe0, 0x30, 0x06, 0x07,
0xe0, 0x30, 0x0e, 0x07,
0xf0, 0x38, 0x1f, 0x0f,
0xf0, 0x6f, 0xf3, 0x8f,
0xf8, 0xc3, 0xe0, 0xcf,
0xfd, 0x81, 0x80, 0x7f,
0xff, 0x01, 0x80, 0x3f,
0xfe, 0x01, 0x80, 0x7f,
0xff, 0x01, 0x80, 0xff,
0xff, 0xc1, 0x81, 0xff,
0xff, 0xf1, 0x87, 0xff,
0xff, 0xff, 0xff, 0xff
};

static const unsigned long palette_picker1BPP_UNCOMP[]=
{
    0x000000,   0xffffff
};

const tImage  picker1BPP_UNCOMP=
{
    IMAGE_FMT_1BPP_UNCOMP,
    32,
    32,
    2,
    palette_picker1BPP_UNCOMP,
    pixel_picker1BPP_UNCOMP,
};


//////////////////


UInt pop_events(UInt *events_ptr, UInt events_to_check) {
    UInt in_events;

    in_events = (*events_ptr) & events_to_check;
    (*events_ptr) &= ~events_to_check;
    return in_events;
}


// The screensaver stackup:
// 7 blocks of 18 px high
// 170 px high photo section
#define UI_IDLE_BLOCK_HEIGHT_PX 18
#define UI_IDLE_BLOCK0_HEIGHT 1
#define UI_IDLE_BLOCK1_HEIGHT 4
#define UI_IDLE_BLOCK2_HEIGHT 2

#define UI_IDLE_BLOCK0_TOP_PX       0
#define UI_IDLE_BLOCK0_HEIGHT_PX    (UI_IDLE_BLOCK0_HEIGHT * UI_IDLE_BLOCK_HEIGHT_PX)
#define UI_IDLE_BLOCK1_TOP_PX       UI_IDLE_BLOCK0_HEIGHT_PX
#define UI_IDLE_BLOCK1_HEIGHT_PX    (UI_IDLE_BLOCK1_HEIGHT * UI_IDLE_BLOCK_HEIGHT_PX)
#define UI_IDLE_BLOCK2_TOP_PX       (UI_IDLE_BLOCK0_HEIGHT_PX + UI_IDLE_BLOCK1_HEIGHT_PX)
#define UI_IDLE_BLOCK2_HEIGHT_PX    (UI_IDLE_BLOCK2_HEIGHT * UI_IDLE_BLOCK_HEIGHT_PX)

#define UI_IDLE_PHOTO_TOP           (UI_IDLE_BLOCK2_TOP_PX + UI_IDLE_BLOCK2_HEIGHT_PX)

#define UI_PICKER_TOP               UI_IDLE_PHOTO_TOP

void ui_draw_screensaver() {
    Graphics_clearDisplay(&ui_gr_context_portrait);

    Graphics_setFont(&ui_gr_context_portrait, &g_sFontCmss16b);
    Graphics_drawStringCentered(
            &ui_gr_context_portrait,
            "- queercon 16 -",
            15,
            64,
            UI_IDLE_BLOCK0_HEIGHT_PX / 2,
            0
    );

    Graphics_setFont(&ui_gr_context_portrait, &g_sFontCmss48b);
    Graphics_drawStringCentered(
            &ui_gr_context_portrait,
            "UBER",
            4,
            64,
            UI_IDLE_BLOCK1_TOP_PX + (UI_IDLE_BLOCK1_HEIGHT_PX / 2),
            0
    );

    Graphics_setFont(&ui_gr_context_portrait, &g_sFontCmtt28);
    Graphics_drawStringCentered(
            &ui_gr_context_portrait,
            "DUPLiCO",
            7,
            64,
            UI_IDLE_BLOCK2_TOP_PX + (UI_IDLE_BLOCK2_HEIGHT_PX / 2),
            0
    );

    Graphics_drawLineH(&ui_gr_context_portrait, 0, 128, UI_IDLE_PHOTO_TOP-2);
    Graphics_drawLineH(&ui_gr_context_portrait, 0, 128, UI_IDLE_PHOTO_TOP-1);

    Graphics_drawImage(&ui_gr_context_portrait, &example_photo1BPP_UNCOMP, 0, UI_IDLE_PHOTO_TOP);

    Graphics_flushBuffer(&ui_gr_context_portrait);
}

#define UI_AUTOREFRESH_TIMEOUT 6000000

#define UI_SCREEN_IDLE 0
#define UI_SCREEN_MAINMENU 1
#define UI_SCREEN_COLORPICKER 2

#define UI_SCREEN_STORY1 101

uint8_t ui_current = UI_SCREEN_STORY1;
uint8_t ui_colorpicking = 0;
uint8_t ui_textentry = 0;

void ui_transition(uint8_t destination) {
    if (ui_current == destination) {
        return; // Nothing to do.
    }
    // TODO: unload the current whatever

    ui_current = destination;
    Event_post(ui_event_h, UI_EVENT_REFRESH);
}

uint8_t ui_colorpicker_cursor_pos = 0;
uint8_t ui_colorpicker_cursor_anim = 0;

void ui_colorpicking_wireframe() {
    Graphics_setBackgroundColor(&ui_gr_context_portrait, GRAPHICS_COLOR_BLACK);
    Graphics_setForegroundColor(&ui_gr_context_portrait, GRAPHICS_COLOR_WHITE);

    Graphics_Rectangle rect = {
        .xMin = 0,
        .yMin = UI_PICKER_TOP,
        .xMax = EPD_WIDTH-1,
        .yMax = EPD_HEIGHT-2
    };

    // Clear the color picker menu area
    Graphics_fillRectangle(&ui_gr_context_portrait, &rect);

    Graphics_setBackgroundColor(&ui_gr_context_portrait, GRAPHICS_COLOR_WHITE);
    Graphics_setForegroundColor(&ui_gr_context_portrait, GRAPHICS_COLOR_BLACK);

    Graphics_drawLineH(&ui_gr_context_portrait, 0, EPD_WIDTH-1, UI_PICKER_TOP);
    Graphics_drawLineH(&ui_gr_context_portrait, 0, EPD_WIDTH-1, UI_PICKER_TOP+1);
    Graphics_drawLineH(&ui_gr_context_portrait, 0, EPD_WIDTH-1, UI_PICKER_TOP+2);
    Graphics_drawLineH(&ui_gr_context_portrait, 0, EPD_WIDTH-1, UI_PICKER_TOP+3);

    // We've got a basically 170-px high frame to work with here.

    Graphics_drawLineH(&ui_gr_context_portrait, 1, EPD_WIDTH-1, EPD_HEIGHT-48);
    Graphics_drawLineH(&ui_gr_context_portrait, 1, EPD_WIDTH-1, EPD_HEIGHT-16);
    for (uint8_t i=1; i<128; i+=21) {
        Graphics_drawLineV(&ui_gr_context_portrait, i, EPD_HEIGHT-16, EPD_HEIGHT-48);
        Graphics_drawLine(&ui_gr_context_portrait, i+10, EPD_HEIGHT-16, (int32_t)((25.6*(i-1))/21), EPD_HEIGHT-1);
    }

    // TODO: Maybe arrows up here instead
    // TODO: defines for these ASAP.
    rect = (Graphics_Rectangle){10,UI_PICKER_TOP+4, EPD_WIDTH-11,UI_PICKER_TOP+4+64};

    if (ui_colorpicker_cursor_anim) {
        Graphics_drawRectangle(&ui_gr_context_portrait, &rect);
    } else {
        // Draw an arrow over the relevant color:
        uint8_t arrow_x = (21*ui_colorpicker_cursor_pos);
        Graphics_drawLine(&ui_gr_context_portrait, arrow_x, EPD_HEIGHT-64, arrow_x+10, EPD_HEIGHT-48);
        Graphics_drawLine(&ui_gr_context_portrait, arrow_x+21, EPD_HEIGHT-64, arrow_x+11, EPD_HEIGHT-48);
    }
}

void ui_colorpicking_load() {
    ui_colorpicking = 1;

    Graphics_Rectangle rect;

    Graphics_setBackgroundColor(&ui_gr_context_portrait, GRAPHICS_COLOR_BLACK);
    Graphics_setForegroundColor(&ui_gr_context_portrait, GRAPHICS_COLOR_WHITE);

    // Fade out the background.
    for (int16_t i=0; i<UI_PICKER_TOP*2; i+=2) {
        Graphics_drawLine(&ui_gr_context_portrait, 0, i, i, 0);
    }

    // Clear the color picker "tab" area
    rect = (Graphics_Rectangle){48,UI_PICKER_TOP-32,
                                80,UI_PICKER_TOP};
    Graphics_fillRectangle(&ui_gr_context_portrait, &rect);

    Graphics_setBackgroundColor(&ui_gr_context_portrait, GRAPHICS_COLOR_WHITE);
    Graphics_setForegroundColor(&ui_gr_context_portrait, GRAPHICS_COLOR_BLACK);

    // Draw the color picker "tab" and the color picker icon.
    Graphics_drawImage(&ui_gr_context_portrait, &picker1BPP_UNCOMP, 48, UI_PICKER_TOP-32);
    Graphics_drawRectangle(&ui_gr_context_portrait, &rect);

    // This will draw everything else:
    Event_post(ui_event_h, UI_EVENT_REFRESH);
    // TODO: Make these match each other (event vs events)
    Event_post(led_events_h, LED_EVENT_SHOW_UPCONF);
}

void ui_colorpicking_unload() {
    // TODO: Deactivate the front lights.
    ui_colorpicking = 0;
    Event_post(ui_event_h, UI_EVENT_REFRESH);
    epd_do_partial = 1;
}

void ui_colorpicking_do(UInt events) {
    if (pop_events(&events, UI_EVENT_REFRESH)) {
        ui_colorpicking_wireframe();
        epd_do_partial = 1;
        Graphics_flushBuffer(&ui_gr_context_landscape);
    }

    if (pop_events(&events, UI_EVENT_KB_PRESS)) {
        switch(kb_active_key_masked) {
        case BTN_BACK:
            ui_colorpicking_unload();
            break;
        case BTN_RED:
            memcpy(&led_tail_anim_current.colors[ui_colorpicker_cursor_pos], &led_rainbow_colors[0], sizeof(rgbcolor16_t));
            Event_post(led_events_h, LED_EVENT_SHOW_UPCONF);
            break;
        case BTN_ORG:
            memcpy(&led_tail_anim_current.colors[ui_colorpicker_cursor_pos], &led_rainbow_colors[1], sizeof(rgbcolor16_t));
            Event_post(led_events_h, LED_EVENT_SHOW_UPCONF);
            break;
        case BTN_YEL:
            memcpy(&led_tail_anim_current.colors[ui_colorpicker_cursor_pos], &led_rainbow_colors[2], sizeof(rgbcolor16_t));
            Event_post(led_events_h, LED_EVENT_SHOW_UPCONF);
            break;
        case BTN_GRN:
            memcpy(&led_tail_anim_current.colors[ui_colorpicker_cursor_pos], &led_rainbow_colors[3], sizeof(rgbcolor16_t));
            Event_post(led_events_h, LED_EVENT_SHOW_UPCONF);
            break;
        case BTN_BLU:
            memcpy(&led_tail_anim_current.colors[ui_colorpicker_cursor_pos], &led_rainbow_colors[4], sizeof(rgbcolor16_t));
            Event_post(led_events_h, LED_EVENT_SHOW_UPCONF);
            break;
        case BTN_PUR:
            memcpy(&led_tail_anim_current.colors[ui_colorpicker_cursor_pos], &led_rainbow_colors[5], sizeof(rgbcolor16_t));
            Event_post(led_events_h, LED_EVENT_SHOW_UPCONF);
            break;
        case BTN_F1_LOCK:
            break;
        case BTN_F2_COIN:
            break;
        case BTN_F3_CAMERA:
            break;
        case BTN_UP: // This is "right"
            if (ui_colorpicker_cursor_pos == 5)
                ui_colorpicker_cursor_pos = 0;
            else
                ui_colorpicker_cursor_pos++;
            Event_post(ui_event_h, UI_EVENT_REFRESH);
            break;
        case BTN_DOWN: // "left"
            if (ui_colorpicker_cursor_pos == 0)
                ui_colorpicker_cursor_pos = 5;
            else
                ui_colorpicker_cursor_pos--;
            Event_post(ui_event_h, UI_EVENT_REFRESH);
            break;
        case BTN_LEFT: // "up"
            if (!ui_colorpicker_cursor_anim) {
                ui_colorpicker_cursor_anim = 1;
                Event_post(ui_event_h, UI_EVENT_REFRESH);
            }
            break;
        case BTN_RIGHT: // "down"
            if (ui_colorpicker_cursor_anim) {
                ui_colorpicker_cursor_anim = 0;
                Event_post(ui_event_h, UI_EVENT_REFRESH);
            }
            break;
        case BTN_OK:
            break;

        }
    }
}

void ui_textentry_load() {

}

void ui_textentry_do(UInt events) {

}

void ui_textentry_unload() {

}

void ui_screensaver_do(UInt events) {
    if (pop_events(&events, UI_EVENT_REFRESH)) {
        ui_draw_screensaver();
    }
}

void ui_task_fn(UArg a0, UArg a1) {
    UInt events;
    uint8_t light_brightness = 0;

    // TODO: move these:
    init_epd();
    ht16d_init_io();
    ht16d_init();
    ht16d_all_one_color(light_brightness,light_brightness,light_brightness);

    ui_transition(UI_SCREEN_IDLE);

    while (1) {
        events = Event_pend(ui_event_h, Event_Id_NONE, ~Event_Id_NONE,  UI_AUTOREFRESH_TIMEOUT);

        // TODO: reorder the buttons based on the current screen configuration.

        if (!events) {
            // This is a timeout.
            if (ui_colorpicking) {
                ui_colorpicking_unload();
            } else if (ui_textentry) {
                // TODO: Do we actually want textentry to idle out?
                ui_textentry_unload();
            } else {
                // TODO: We need to make sure to avoid race conditions here.
                ui_transition(UI_SCREEN_IDLE);
            }
            continue;
        }

        // TODO: Should we prefer release?
        // NB: This order is very important:
        if (kb_active_key_masked == BTN_F4_PICKER
                && pop_events(&events, UI_EVENT_KB_PRESS)) {
            if (ui_colorpicking) {
                ui_colorpicking_unload();
            } else {
                ui_colorpicking_load();
            }
        }

        if (kb_active_key_masked == BTN_ROT
                && ui_current != UI_SCREEN_IDLE
                && !ui_colorpicking
                && pop_events(&events, UI_EVENT_KB_PRESS)) {
            // The rotate button is pressed, and we're NOT in one of the
            //  portrait modes:
            epd_flip();
            // TODO: Should we ignore keypresses while the screen is updating?
            Graphics_flushBuffer(&ui_gr_context_landscape);
        }

        if (ui_colorpicking) {
            ui_colorpicking_do(events);
        } else if (ui_textentry) {
            ui_textentry_do(events);
        } else {
            // If neither of our "overlay" options are in use, then we follow
            //  a normal state flow:
            switch(ui_current) {
            case UI_SCREEN_IDLE:
                ui_screensaver_do(events);
                break;
            }

        }
    }
}

void ui_init() {
    // IO init:

    // TODO: consider enabling hysteresis?
    // The ROW SCAN sets ROWS as INPUTS, with PULL DOWNS
    //              and, COLS as OUTPUTS, HIGH.

    kb_pin_h = PIN_open(&btn_state, btn_row_scan);

    Clock_Params clockParams;
    Error_Block eb;
    Error_init(&eb);
    Clock_Params_init(&clockParams);
    clockParams.period = UI_CLOCK_TICKS;
    clockParams.startFlag = TRUE;
    kb_debounce_clock_h = Clock_create(kb_clock_swi, 2, &clockParams, &eb);

    // TODO: rename all the taskParams and such
    Task_Params taskParams;
    Task_Params_init(&taskParams);
    taskParams.stack = ui_task_stack;
    taskParams.stackSize = UI_STACKSIZE;
    taskParams.priority = 1;
    Task_construct(&ui_task, ui_task_fn, &taskParams, NULL);

    Graphics_initContext(&ui_gr_context_landscape, &epd_gr_display_landscape, &epd_grDisplayFunctions);
    Graphics_setBackgroundColor(&ui_gr_context_landscape, GRAPHICS_COLOR_WHITE);
    Graphics_setForegroundColor(&ui_gr_context_landscape, GRAPHICS_COLOR_BLACK);
    Graphics_clearDisplay(&ui_gr_context_landscape);

    Graphics_initContext(&ui_gr_context_portrait, &epd_gr_display_portrait, &epd_grDisplayFunctions);
    Graphics_setBackgroundColor(&ui_gr_context_portrait, GRAPHICS_COLOR_WHITE);
    Graphics_setForegroundColor(&ui_gr_context_portrait, GRAPHICS_COLOR_BLACK);
    Graphics_clearDisplay(&ui_gr_context_portrait);

    ui_event_h = Event_create(NULL, NULL);
}
